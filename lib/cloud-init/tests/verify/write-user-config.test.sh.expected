#cloud-config

hostname: vm999

apt:
  preserve_sources_list: true
package_update: true
package_upgrade: true
package_reboot_if_required: true
packages:
  - qemu-guest-agent

users:
  - name: radiko
    groups: sudo
    shell: /bin/bash
    # TODO: Remove password
    lock_passwd: false
    plain_text_passwd: pw
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys: 
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBBCUt4uHcGH8b4xf8aJSCvg3EXW5Pom0LyV7ll5EQTYmDux/B7CWh+W8C7xMZzKAspat/uyXe2lsCzN6ruwZHbtms0T3M6hxygUv7xkZlKnPlfLXmvjleLZj5PmehAZay1o3rIFvxw57uq0kxzJasqzutHpA3i9+l1occoj8Xp/MT/FT3kglg40ZLReOjOC9ZcsIm/KATuvU0T/xprVE0nAwSgt5oz1ueWG4KnE2HmszHPSfSZgq5Zxzhnvn+CnJ/sM7oqYik28QvzTYMg9a7u98NoZXeNJzXsqies6VlwL6Q5Qvzl0IV8IwlLXvquQwEBITdYJCEf9la2i/4qUsN root@saturn
  - name: stivisto
    shell: /bin/bash
    # TODO: Remove password
    lock_passwd: false
    plain_text_passwd: pw
    ssh_authorized_keys: 
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBBCUt4uHcGH8b4xf8aJSCvg3EXW5Pom0LyV7ll5EQTYmDux/B7CWh+W8C7xMZzKAspat/uyXe2lsCzN6ruwZHbtms0T3M6hxygUv7xkZlKnPlfLXmvjleLZj5PmehAZay1o3rIFvxw57uq0kxzJasqzutHpA3i9+l1occoj8Xp/MT/FT3kglg40ZLReOjOC9ZcsIm/KATuvU0T/xprVE0nAwSgt5oz1ueWG4KnE2HmszHPSfSZgq5Zxzhnvn+CnJ/sM7oqYik28QvzTYMg9a7u98NoZXeNJzXsqies6VlwL6Q5Qvzl0IV8IwlLXvquQwEBITdYJCEf9la2i/4qUsN root@saturn

write_files:
  - path: /etc/ssh/sshd_config
    append: true
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      Port 4444
  - path: /var/lib/cloud/scripts/per-instance/10-install-docker.sh
    permissions: "0500"
    content: |
      #!/bin/bash
      set -euo pipefail
      
      # Install docker
      # Source: https://docs.docker.com/engine/install/ubuntu/
      
      echo "➡️  Uninstall old versions"
      sudo apt-get remove \
      docker \
      docker-engine \
      docker.io \
      containerd \
      runc
      
      echo "➡️  Install apt dependencies"
      sudo apt-get update
      sudo apt-get install \
      ca-certificates \
      curl \
      gnupg
      
      echo "➡️  Add Docker official GPG key"
      sudo mkdir -m 0755 -p /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      
      echo "➡️  Set up the repository"
      echo \
      "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      
      echo "➡️  Install Docker Engine"
      sudo apt-get update
      sudo apt-get install \
      docker-ce \
      docker-ce-cli \
      containerd.io \
      docker-buildx-plugin \
      docker-compose-plugin
      
      
      # Post install steps
      # Source: https://docs.docker.com/engine/install/linux-postinstall/
      
      echo "➡️  Create the docker group"
      sudo groupadd docker
      
      echo "➡️  Add user to group"
      sudo usermod -aG docker "radiko"
      
      
      # TODO: Change docker logging provider
      # Source: https://docs.docker.com/engine/install/linux-postinstall/#configure-default-logging-driver

bootcmd: 
  - echo "*********************************"
  - echo "Executing bootcmd"
  - echo "*********************************"
  - if [ ! -f /root/first-run-complete ]; then echo "IS FIRST RUN"; else echo "NOT FIRST RUN"; fi
  - if [ ! -f /root/first-run-complete ]; then netplan apply; fi
  - echo "###### IP Addresses"
  - ip -c -br addr
  - echo "###### IP Routes"
  - ip -c route

runcmd: 
  - echo "*********************************"
  - echo "Executing runcmd"
  - echo "*********************************"
  - systemctl restart ssh
  - systemctl start qemu-guest-agent
  - touch /root/first-run-complete
