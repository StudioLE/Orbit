#cloud-config

hostname: instance-01
apt:
  preserve_sources_list: true
package_update: true
package_upgrade: true
package_reboot_if_required: true
groups:
- docker
users:
- name: admin
  groups: sudo, docker
  shell: /bin/bash
  sudo: ALL=(ALL) NOPASSWD:ALL
  lock_passwd: true
  ssh_authorized_keys: []
- name: user
  shell: /bin/bash
  lock_passwd: true
  ssh_authorized_keys: []
wireguard:
  interfaces:
  - name: wg1
    config_path: /etc/wireguard/wg1.conf
    content: |-
      [Interface]
      PrivateKey = 8Dh1P7/6fm9C/wHYzDrEhnyKmFgzL6yH6WuslXPLbVQ=
      Address = 10.1.1.0
      Address = fc00:1:1::
      [Peer]
      PublicKey = Rc9kAH9gclSHur2vbbmIj3pvWizuxB5ly1Drv0tRXRE=
      AllowedIPs = 0.0.0.0/0, ::/0
      Endpoint = 203.0.113.1:51820
write_files:
- path: /etc/ssh/sshd_config
  append: true
  content: |
    PermitRootLogin no
    PasswordAuthentication no
    Port 22
- path: /var/lib/cloud/scripts/per-instance/00-log.sh
  permissions: 0o500
  content: |
    #!/bin/bash
    set -euo pipefail

    date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
    echo "Executing installers" | sudo tee -a /var/log/orbit.log
- path: /var/lib/cloud/scripts/per-instance/10-install-docker.sh
  permissions: 0o500
  content: |
    #!/bin/bash
    set -euo pipefail

    date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
    echo "Installing docker" | sudo tee -a /var/log/orbit.log

    curl -fsS https://install.studiole.uk/docker | sudo bash
- path: /var/lib/cloud/scripts/per-instance/90-install-network-test.sh
  permissions: 0o500
  content: |
    #!/bin/bash
    set -euo pipefail

    date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
    echo "Installing network-test" | sudo tee -a /var/log/orbit.log

    curl -fsS https://install.studiole.uk/network-test | sudo bash
- path: /var/lib/cloud/scripts/per-instance/99-log.sh
  permissions: 0o500
  content: |
    #!/bin/bash
    set -euo pipefail

    date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
    echo "Executed installers" | sudo tee -a /var/log/orbit.log
bootcmd:
- echo "*********************************"
- echo "Executing bootcmd"
- echo "*********************************"
- echo "###### IP Addresses"
- ip -br addr
- echo "###### IP Routes"
- ip route
- date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
- echo "Executed bootcmd" | sudo tee -a /var/log/orbit.log
- ''
runcmd:
- echo "*********************************"
- echo "Executing runcmd"
- echo "*********************************"
- systemctl restart ssh
- date --rfc-3339 ns | tr '\n' ' ' | sudo tee -a /var/log/orbit.log
- echo "Executed runcmd" | sudo tee -a /var/log/orbit.log
- ''
