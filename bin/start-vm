#!/bin/bash
set -euo pipefail

# ARGS

ID=${1}

# VALIDATE

if [[ "${ID}" == "" ||  "${ID}" -lt "100" || "${ID}" -gt "253" ]];
then
    echo "❗  Invalid ID: ${ID}" >&2
    exit 1
fi

# START

echo "➡️  Start VM ${ID}"
qm start "${ID}"

START_TIME="$(date -u +%s)"

# Wait for the cloud-init status to show done
while :
do
  CURRENT_TIME="$(date -u +%s)"
  ELAPSED="$((CURRENT_TIME - START_TIME))"
  echo "⌛  ${ELAPSED} seconds"

  RESPONSE=$(ssh "10.10.10.${ID}" -o 'LogLevel=FATAL' -o 'ConnectTimeout=1' 'cloud-init status')
  EXIT_CODE=$?
  
  if [[ "${RESPONSE}" == "status: done" ]]
  then
    echo "${RESPONSE}"
    echo "✅ VM is Ready"
    break
  elif [[ "${RESPONSE}" == "" ]]
  then
    echo "SSH Exit code: ${EXIT_CODE}"
  else
    echo "${RESPONSE}"
  fi

  sleep 2s
done
